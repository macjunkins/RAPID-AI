# Story 1.3.1: Implement Claude Code CLI Integration

**Epic:** 1.3 - Implement Documentation-as-you-go Workflow Integration
**Story:** 1.3.1 - Implement Claude Code CLI Integration
**Type:** Brownfield Enhancement
**Status:** Ready for Development

---

## Story Title

Implement Claude Code CLI Integration - Brownfield Addition

## User Story

As a **RAPID-AI developer**,
I want **consistent AI analysis results whether I use Copilot CLI or Claude Code CLI**,
So that **the choice of AI tool doesn't affect the quality of discovery and implementation planning outputs**.

## Story Context

**Existing System Integration:**
- Integrates with: AI tool abstraction layer in `core/workflows/common-functions.sh`
- Technology: Bash shell scripting, CLI tool invocation
- Follows pattern: Copilot CLI integration (lines 181-183)
- Touch points:
  - `run_ai_analysis()` function (line 155)
  - `check_ai_tool_availability()` function (line 108)
  - `.ai-workflow.yaml` configuration (lines 8-11)

**Current Problem:**
The system was designed with placeholders for three AI tools:
1. **GitHub Copilot CLI** (`copilot`) - ✅ Fully implemented and working
2. **Claude API** (`claude`) - ❌ Placeholder function, not implemented
3. **OpenAI GPT-4 API** (`gpt4`) - ❌ Placeholder function, not implemented

However, users have **Claude Code CLI** installed (`~/.npm-global/bin/claude`), which is a **different tool** from the Claude API. When users set `AI_TOOL=claude`, the system:
1. Calls `claude_api_call()` placeholder function
2. Gets "not implemented" error
3. Falls back to template generation
4. **Never invokes the installed Claude Code CLI**

This causes inconsistent results between `AI_TOOL=copilot` (uses real AI) and `AI_TOOL=claude` (uses fallback template).

## Acceptance Criteria

### Functional Requirements

1. **Claude Code CLI Integration**
   - System detects Claude Code CLI at `~/.npm-global/bin/claude` or in PATH
   - New tool option `claude-code` invokes: `claude -p "$prompt" --print`
   - Output processing matches Copilot CLI pattern (same temp file handling)

2. **Configuration Support**
   - `.ai-workflow.yaml` accepts `claude-code` in `ai_tools` array
   - Documentation comments explain difference between `claude` vs `claude-code`
   - Example configuration shows proper usage

3. **Tool Detection & Error Handling**
   - `check_ai_tool_availability("claude-code")` validates CLI is installed
   - Helpful error messages if Claude Code CLI not found
   - Installation instructions point to correct URL

### Integration Requirements

4. **Existing functionality continues to work unchanged**
   - `AI_TOOL=copilot` continues working exactly as before
   - Existing placeholder `claude_api_call()` preserved for future API integration
   - `gpt4` placeholder remains unchanged

5. **New functionality follows existing pattern**
   - Claude Code CLI integration mirrors Copilot CLI implementation exactly
   - Same timeout handling, same progress indicators
   - Same temp file management and output processing

6. **Integration with AI tool abstraction maintains current behavior**
   - `run_ai_analysis()` switch statement gains new case
   - `check_ai_tool_availability()` gains new case
   - No changes to function signatures or return values

### Quality Requirements

7. **Change is covered by appropriate tests**
   - Manual testing with actual Claude Code CLI installation
   - Verification that output format matches Copilot format
   - Confirm backward compatibility with existing workflows

8. **Documentation is updated**
   - [README.md](README.md) AI Tools section clarifies three options
   - [CLAUDE.md](CLAUDE.md) ## Critical Patterns updated with tool details
   - `.ai-workflow.yaml` comments explain when to use each tool

9. **No regression in existing functionality verified**
   - Test Story 1.3 workflows still work with `copilot`
   - Test fallback templates still generate when tool unavailable
   - Test progress indicators and timeout protection still work

## Technical Notes

### Integration Approach

**File:** [core/workflows/common-functions.sh](core/workflows/common-functions.sh)

**Change 1: Add Claude Code CLI detection** (line 108, `check_ai_tool_availability`)
```bash
case "$tool" in
    "copilot")
        # Existing copilot check (lines 112-131)
        ;;
    "claude-code")
        # NEW: Check for Claude Code CLI
        if ! command -v claude &> /dev/null; then
            echo "❌ Claude Code CLI not found"
            echo "💡 To install Claude Code CLI:"
            echo "   1. Visit: https://docs.claude.com/en/docs/claude-code"
            echo "   2. Follow installation instructions for your platform"
            echo "   3. Verify: claude --version"
            return 1
        fi
        # No auth check needed - Claude Code handles auth interactively
        ;;
    "claude")
        # Existing placeholder for Claude API (lines 133-136)
        ;;
esac
```

**Change 2: Add Claude Code CLI invocation** (line 180, `run_ai_analysis`)
```bash
case "$tool" in
    "copilot")
        # Existing copilot invocation (line 182)
        timeout ${timeout}s copilot -p "$prompt" > "$temp_output" 2>&1 &
        AI_PID=$!
        ;;
    "claude-code")
        # NEW: Invoke Claude Code CLI with same pattern
        timeout ${timeout}s claude -p "$prompt" --print > "$temp_output" 2>&1 &
        AI_PID=$!
        ;;
    "claude")
        # Existing placeholder (lines 185-187)
        timeout ${timeout}s claude_api_call "$prompt" > "$temp_output" 2>&1 &
        AI_PID=$!
        ;;
esac
```

**Change 3: Update configuration** [.ai-workflow.yaml](/.ai-workflow.yaml)
```yaml
ai_tools:
  - "copilot"       # GitHub Copilot CLI (gh copilot CLI extension)
  # - "claude-code" # Claude Code CLI (Anthropic's CLI tool)
  # - "claude"      # Claude API (future: direct API integration)
  # - "gpt4"        # OpenAI GPT-4 API (future: direct API integration)
```

### Existing Pattern Reference

The Copilot CLI integration at lines 181-183 is the exact pattern to follow:
1. Use `timeout` command for timeout protection
2. Invoke CLI with `-p` flag for prompt
3. Redirect output to temp file
4. Run in background with `&`, capture PID
5. Wait for completion and check exit code

Claude Code CLI uses **identical interface** to Copilot CLI:
- Both use `-p "prompt"` syntax
- Both output to stdout
- Both support timeout interruption
- Both return 0 on success

### Key Constraints

1. **Preserve API Placeholders**: Keep `claude_api_call()` and `openai_api_call()` functions for future work
2. **Naming Convention**: Use "claude-code" to distinguish CLI from API
3. **No Breaking Changes**: Existing `AI_TOOL=copilot` must continue working identically
4. **Follow Patterns**: Copy Copilot implementation exactly (it's proven to work)

## Definition of Done

- [x] Investigation complete and problem understood
- [ ] Claude Code CLI detection implemented in `check_ai_tool_availability()`
- [ ] Claude Code CLI invocation implemented in `run_ai_analysis()`
- [ ] Configuration file updated with clear comments
- [ ] README.md AI Tools section updated
- [ ] CLAUDE.md updated with tool abstraction details
- [ ] Manual testing with Claude Code CLI confirms correct output
- [ ] Backward compatibility verified (existing workflows unchanged)
- [ ] Documentation reviewed and accurate

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Claude Code CLI might require authentication or configuration that differs from Copilot
**Mitigation:** Add clear error messages and setup instructions if auth fails

**Rollback:** Simply don't use `AI_TOOL=claude-code` - existing tools unaffected

### Compatibility Verification

- [x] No breaking changes to existing APIs
- [x] Database changes: None (no database in this project)
- [x] UI changes: None (CLI-only changes)
- [x] Performance impact: Negligible (same pattern as existing code)

## Validation Checklist

### Scope Validation

- [x] Story can be completed in one development session (~2 hours)
- [x] Integration approach is straightforward (copy existing pattern)
- [x] Follows existing patterns exactly (Copilot CLI integration)
- [x] No design or architecture work required

### Clarity Check

- [x] Story requirements are unambiguous
- [x] Integration points are clearly specified (lines 108, 180 in common-functions.sh)
- [x] Success criteria are testable (manual testing with actual CLI)
- [x] Rollback plan is simple (don't use new option)

## Implementation Notes

### Discovery Findings

**Investigation Date:** 2025-10-23

**Tools Found:**
- Copilot CLI: `/Users/johnjunkins/.npm-global/bin/copilot` (working)
- Claude CLI: `/Users/johnjunkins/.npm-global/bin/claude` (installed but not integrated)

**Current Behavior:**
```bash
# Working (uses real AI)
AI_TOOL=copilot ./core/scripts/ai-discovery.sh 1 3 "Test Story" output.md

# Not working (uses fallback template)
AI_TOOL=claude ./core/scripts/ai-discovery.sh 1 3 "Test Story" output.md
```

**Expected Behavior After Fix:**
```bash
# Original working
AI_TOOL=copilot ./core/scripts/ai-discovery.sh 1 3 "Test Story" output.md

# New working option
AI_TOOL=claude-code ./core/scripts/ai-discovery.sh 1 3 "Test Story" output.md
```

### Files Modified

1. [core/workflows/common-functions.sh](core/workflows/common-functions.sh) - Add Claude Code CLI integration (~20 lines)
2. [.ai-workflow.yaml](./.ai-workflow.yaml) - Update comments (~4 lines)
3. [README.md](README.md) - Update AI Tools section (~10 lines)
4. [CLAUDE.md](CLAUDE.md) - Update AI integration notes (~5 lines)

**Total LOC Changed:** ~40 lines (all additive, no deletions)

---

## Dev Agent Record

### Debug Log References
- Investigation completed: 2025-10-23
- Root cause identified: Placeholder function never implemented, but Claude Code CLI is installed
- Solution approach: Add "claude-code" option that invokes installed CLI

### Testing Plan
1. Install/verify Claude Code CLI
2. Test with `AI_TOOL=claude-code` on simple prompt
3. Compare output format to Copilot output
4. Verify timeout handling works
5. Test error handling when CLI not installed
6. Verify existing `copilot` option still works

### Dependencies
- Requires Claude Code CLI installed (user already has it)
- No new npm packages or dependencies
- No changes to other RAPID-AI components
